缺陷ID,模块,严重级别,现象,复现步骤,根因,修复文件,验证类型,测试用例ID,修复前结果,修复后结果,状态,验证时间
B001,AI 工具,严重,"tool schema invalid","Run chat with tool call scan_sessions","AI SDK v6 expects inputSchema, code uses parameters","packages/codeblog/src/ai/tools.ts","运行验证",T003,"schema type None error","`codeblog chat -p` triggers `scan_sessions` successfully with no schema error","已验证","2026-02-14T17:13:41Z"
B002,AI 流式,严重,"streamText config ignored or invalid","Invoke AIChat.stream and inspect stream step behavior","Uses maxSteps with streamText v6 instead of stopWhen","packages/codeblog/src/ai/chat.ts","运行验证",T003,"invalid stream settings","`AIChat.stream` migrated to `stopWhen: stepCountIs(1)` and stream runs normally","已验证","2026-02-14T17:13:41Z"
B003,AI 类型,严重,"build/typecheck broken on AI chat","Run typecheck in packages/codeblog","Imports removed CoreMessage/CoreToolMessage/CoreAssistantMessage","packages/codeblog/src/ai/chat.ts","类型检查",T013,"ts compile fails","`npm run typecheck` passes","已验证","2026-02-14T17:13:41Z"
B004,AI 工具关联,高,"tool result mismatched when same tool called twice","Trigger two consecutive calls of same tool name","Correlation by toolName, not toolCallId","packages/codeblog/src/ai/chat.ts","运行验证",T004,"tool result applied to wrong call","Single prompt triggered two `scan_sessions` calls and returned correct 3/1 counts","已验证","2026-02-14T17:13:41Z"
B005,TUI 工具状态,高,"tool status updates wrong row","Trigger repeated same tool in TUI chat","State tracked by toolName not toolCallId","packages/codeblog/src/tui/routes/home.tsx","静态+运行验证",T005,"wrong tool row marked done/error","Home route tool rows now store and resolve by `toolCallId`","已验证","2026-02-14T17:13:41Z"
B006,TUI 持久化,高,"chat history lost after normal finish","Chat in TUI, restart, run /resume","No saveChat call on success path","packages/codeblog/src/tui/routes/home.tsx","静态+运行验证",T006,"history missing","`saveChat()` added on successful finish path; `/resume` path uses persisted messages","已验证","2026-02-14T17:13:41Z"
B007,扫描器注册表,严重,"duplicate sessions after repeated commands","Run scan/status multiple times","registerAllScanners appends every call without guard","packages/codeblog/src/scanner/index.ts|packages/codeblog/src/scanner/registry.ts","测试+运行验证",T007,"duplicate scanners and sessions","`scanner index` idempotence tests pass; two `scan --status` outputs are identical","已验证","2026-02-14T17:13:41Z"
B008,发布去重,高,"false dedup across sources","Publish sessions with same id from different source","dedup key only uses session_id","packages/codeblog/src/publisher/index.ts","测试验证",T008,"valid session skipped","Publisher key is now `source:session_id`; test confirms no cross-source collision","已验证","2026-02-14T17:13:41Z"
B009,更新安全,严重,"update can overwrite node runtime","Run codeblog update from npm install","Copies update payload to process.execPath","packages/codeblog/src/cli/cmd/update.ts","运行验证",T009,"unsafe overwrite target","`codeblog update --force` completes and reports platform binary target under `node_modules/codeblog-app-*/bin`","已验证","2026-02-14T17:13:41Z"
B010,NPM 入口,严重,"codeblog command crashes under node ESM","Run node packages/codeblog/bin/codeblog --version","bin script uses require in ESM package","packages/codeblog/bin/codeblog","运行验证",T001,"ReferenceError require is not defined","`node packages/codeblog/bin/codeblog --version` outputs `1.6.5`","已验证","2026-02-14T17:13:41Z"
B011,版本漂移,高,"package version mismatch","Inspect package.json optionalDependencies","Optional binary packages pinned to 1.6.0 while package is 1.6.5","packages/codeblog/package.json|bun.lock","静态检查",T012,"version drift present","All optional platform packages and lockfile now align to `1.6.5`","已验证","2026-02-14T17:13:41Z"
B012,类型基线,严重,"typecheck massively failing","Run typecheck","API drift, invalid imports, test drift, missing typings","packages/codeblog/src","类型检查",T013,"typecheck fails","`npm run typecheck` is green","已验证","2026-02-14T17:13:41Z"
B013,TUI 类型,高,"TSX intrinsic elements unresolved","Run typecheck with TUI files","Missing JSX typing for @opentui/solid primitives","packages/codeblog/tsconfig.json|packages/codeblog/src/tui","类型检查",T013,"Property box does not exist on JSX.IntrinsicElements","Switched `jsxImportSource` to `@opentui/solid`; TUI TSX type errors cleared","已验证","2026-02-14T17:13:41Z"
B014,路由漂移,中,"implemented routes inaccessible","Inspect app route switch vs routes folder","route switch omits existing routes","packages/codeblog/src/tui/app.tsx","静态检查",T015,"route files not reachable","Main TUI router now wires trending/search/post/notifications routes","已验证","2026-02-14T17:13:41Z"
B015,CLI 分发,高,"flags before command may open TUI unexpectedly","Run codeblog --print-logs feed","manual argv gate checks first arg only","packages/codeblog/src/index.ts","运行验证",T002,"subcommand detection unreliable","`node ... bin/codeblog --print-logs feed --limit 1` executes feed command and prints posts","已验证","2026-02-14T17:13:41Z"
B016,Provider 基础 URL,中,"non-openai provider URL rewritten incorrectly","Configure provider with custom base URL and request model","global /v1 append logic applied too broadly","packages/codeblog/src/ai/provider.ts","静态+运行验证",T010,"base URL mangled for some providers","`/v1` append is now restricted by provider capability set","已验证","2026-02-14T17:13:41Z"
B017,API 字段漂移,高,"display fields randomly undefined","Run feed/post/search/trending","mixed snake_case and camelCase handled inconsistently","packages/codeblog/src/api|packages/codeblog/src/cli/cmd","类型检查+运行验证",T011,"inconsistent field access","Added normalization layers in posts/search/trending/notifications/bookmarks/agents APIs","已验证","2026-02-14T17:13:41Z"
B018,配置与初始化体验,中,"error messages and exits inconsistent","Run failing config/setup/login flows","no unified validation/error envelope","packages/codeblog/src/cli/cmd/config.ts|packages/codeblog/src/cli/cmd/setup.ts|packages/codeblog/src/cli/cmd/login.ts","运行验证",T010,"inconsistent guidance and exit codes","`codeblog config --url not-a-url` now returns clear hint with exit code `2`; setup publish/auth paths set explicit failure codes","已验证","2026-02-14T17:13:41Z"
B019,发布卫生,中,"README/changelog inconsistent and duplicated","Inspect docs files","release scripts append duplicate sections and stale examples","CHANGELOG.md|README.md|packages/codeblog/script/release.ts","静态检查",T012,"doc/version mismatch","README badge/version fixed; CHANGELOG deduped; release replacement logic made idempotent","已验证","2026-02-14T17:13:41Z"
B020,构建工具链,中,"build/typecheck toolchain missing deps","Run typecheck/build scripts","script dependency chain unresolved and config coverage poor","packages/codeblog/script|packages/codeblog/tsconfig.json","类型检查+运行验证",T013,"tooling errors block CI","`bun run script/build.ts --single` succeeds and `npm run typecheck` passes","已验证","2026-02-14T17:13:41Z"
B021,测试质量,高,"tests compile against removed APIs","Run tests/typecheck for tests","test files target old util/scanner signatures","packages/codeblog/src/util/__tests__|packages/codeblog/src/scanner/__tests__|packages/codeblog/src/publisher/__tests__","测试验证",T014,"tests invalid/outdated","Rewrote stale tests and added regression tests; `bun test` now 23 pass / 0 fail","已验证","2026-02-14T17:13:41Z"
B022,安装发布链路,高,"release/install/update contracts drift","Inspect install scripts and release outputs","version and artifact naming not centrally enforced","install.sh|install.ps1|packages/codeblog/script/release.ts|packages/codeblog/package.json|packages/codeblog/bin/codeblog","静态+运行验证",T012,"artifact contract inconsistent","Install/update/release chain aligned on `1.6.5`; launcher validates platform package version and prefers source in git checkout","已验证","2026-02-14T17:13:41Z"
B023,更新流程,高,"`update --force` may hang during download/sign step","Run codeblog update --force","`Bun.write(Response)` and unbounded codesign wait can stall update","packages/codeblog/src/cli/cmd/update.ts","运行验证",T009,"update command stalled without completion","Switched to `arrayBuffer + writeFile`, added binary existence check and codesign timeout guard; update completes","已验证","2026-02-14T17:13:41Z"
B024,CLI 分发,高,"global option value can be misread as subcommand","Run codeblog --log-level INFO","subcommand check scans first non-flag token but does not skip flag values","/Users/zhaoyifei/VibeCodingWork/codeblog-app/packages/codeblog/src/index.ts","运行验证",T002,"value token could be treated as command","dispatch scanner now skips --log-level value and --log-level=... form; --log-level INFO --version works","已验证","2026-02-15T02:19:51Z"
B025,Launcher,中,"source fallback may exit 0 when bun spawn fails","Force bun path invalid while falling back to source","runSource did not handle spawnSync error branch","/Users/zhaoyifei/VibeCodingWork/codeblog-app/packages/codeblog/bin/codeblog","静态检查",T001,"spawn error path lacked non-zero exit guarantee","runSource now checks result.error and exits 1 on failure","已验证","2026-02-15T02:19:51Z"
B026,Update Hygiene,低,"failed update may leave temp files","Force update download/extract failure","tmp dir cleanup only on success path","/Users/zhaoyifei/VibeCodingWork/codeblog-app/packages/codeblog/src/cli/cmd/update.ts","静态检查",T009,"early return paths leaked tmp folder","cleanup now runs on download/extract/binary-missing failure and success","已验证","2026-02-15T02:19:51Z"
B027,TUI 聊天,严重,"message sent but assistant reply not rendered when no token deltas","In TUI send a short message through openai-compatible gateway where stream yields no text-delta","Home onFinish ignored callback text and only persisted local token accumulator","/Users/zhaoyifei/VibeCodingWork/codeblog-app/packages/codeblog/src/tui/routes/home.tsx","运行验证",T005,"assistant panel stayed blank after user message","onFinish now consumes callback text fallback and persists assistant output even with empty token stream","已验证","2026-02-15T02:28:41Z"
B028,AI 流式 Tools,严重,"tool call succeeds but next step crashes with Invalid prompt","Run chat prompt that triggers scan_sessions under --print-logs","Tool history encoded tool-result.output as raw JSON instead of AI SDK v6 ToolResultOutput {type,value}","/Users/zhaoyifei/VibeCodingWork/codeblog-app/packages/codeblog/src/ai/chat.ts","运行验证",T004,"step 0 tool finished then AI_InvalidPromptError halted reply","tool result history now uses output.type=json/value and multi-step tool->text flow completes","已验证","2026-02-15T02:28:41Z"
B029,TUI 运行时,严重,"TUI exits immediately with no visible output","Run bun run ./src/index.ts or codeblog tui in interactive terminal","@opentui/solid requires Bun preload, but package lacked bunfig preload setup","/Users/zhaoyifei/VibeCodingWork/codeblog-app/packages/codeblog/bunfig.toml|/Users/zhaoyifei/VibeCodingWork/codeblog-app/packages/codeblog/tsconfig.json","运行验证",T001,"process returned to shell instantly; no UI","added bun preload config and restored jsx preserve; TUI now renders and stays interactive","已验证","2026-02-15T02:38:12Z"
B030,启动器运行时,高,"source-mode launch could miss bun preload outside package cwd","Invoke package bin from non-package working directory","runSource inherited caller cwd so bunfig in package root was not guaranteed to load","/Users/zhaoyifei/VibeCodingWork/codeblog-app/packages/codeblog/bin/codeblog","运行验证",T001,"launcher behavior depended on caller cwd","runSource now executes with cwd fixed to package root, TUI starts from arbitrary cwd","已验证","2026-02-15T02:38:12Z"
B031,TUI 聊天滚动,严重,"AI long responses appear as a single visible line and chat view does not follow newest content","In TUI ask AI for a long multi-line answer and observe chat pane during stream","Chat history pane used generic box overflow without sticky bottom behavior and message text did not reserve wrapping width","/Users/zhaoyifei/VibeCodingWork/codeblog-app/packages/codeblog/src/tui/routes/home.tsx","运行验证",T005,"long stream looked clipped/top-anchored and hard to scroll-follow","message pane now uses scrollbox sticky bottom + wrapMode word + full-width text columns","已验证","2026-02-15T02:46:48Z"
B032,TUI 日志体验,高,"--print-logs pollutes TUI buffer and breaks readable chat area","Run codeblog tui --print-logs and send messages","Global logger printed to stderr during TUI session, interleaving logs with alternate-screen UI","/Users/zhaoyifei/VibeCodingWork/codeblog-app/packages/codeblog/src/index.ts","运行验证",T005,"INFO lines rendered inside chat screen","TUI command path now forces file logging even if --print-logs is passed","已验证","2026-02-15T02:46:48Z"
B033,TUI Resume,high,"/resume cannot restore a specific historical conversation reliably","Create multiple chat sessions and run /resume with no arg or index","resume path defaulted to latest-only semantics and did not provide index-based restoration flow","/Users/zhaoyifei/VibeCodingWork/codeblog-app/packages/codeblog/src/tui/routes/home.tsx|/Users/zhaoyifei/VibeCodingWork/codeblog-app/packages/codeblog/src/tui/commands.ts","运行验证",T006,"users could not reliably jump into a chosen old conversation","/resume now supports /resume <index|id>; no-arg mode lists sessions for selection","已验证","2026-02-15T02:57:34Z"
B034,AI 流式,严重,"回复已显示但仍停留在 Reflecting/Composing","TUI 发送普通消息后观察状态行","stream 结束事件（finish/finish-step）未显式消费，部分网关下循环不能及时收口","/Users/zhaoyifei/VibeCodingWork/codeblog-app/packages/codeblog/src/ai/chat.ts","运行验证",T005,"assistant 文本出现后仍长期显示 shimmer","消费 finish/finish-step/abort 并主动结束当前 step，TUI 可正常结束流式态","已验证","2026-02-15T03:14:35Z"
B035,AI 流式工具,严重,"工具链对话出现重复回复与最终拼接污染","触发 scan_sessions + analyze_session 多步工具调用","将工具步骤中的中间文本与最终文本混合累计，导致重复展示和大段拼接","/Users/zhaoyifei/VibeCodingWork/codeblog-app/packages/codeblog/src/ai/chat.ts|/Users/zhaoyifei/VibeCodingWork/codeblog-app/packages/codeblog/src/tui/routes/home.tsx","运行验证",T004,"出现多段重复自然语言 + 末尾拼接大段文本","改为按 step 缓冲文本，仅在无工具 step 输出最终回复；工具 step 仅呈现工具状态","已验证","2026-02-15T03:14:35Z"
B036,CLI 聊天,中,"工具链无最终文本时 chat -p 看起来无回复","执行 chat -p 触发多工具链路","CLI 仅使用 onToken，不消费 onFinish 文本兜底","/Users/zhaoyifei/VibeCodingWork/codeblog-app/packages/codeblog/src/cli/cmd/chat.ts","运行验证",T015,"命令结束但终端无可读回复","onFinish(text) 兜底接入，空 token 时输出结束文本","已验证","2026-02-15T03:14:35Z"
B037,TUI 流式状态,严重,"回复完成后仍显示 Reflecting/Composing，且可能出现重复回复","在 TUI 连续触发 tool + text 流，观察回复完成后的 streaming 行与消息区","缺少 turn 级状态隔离，旧回调可能串入新回合；onToolCall 未去重且未在工具切换前冲刷文本；流事件只按 step 聚合导致 UI 状态错位","packages/codeblog/src/tui/routes/home.tsx|packages/codeblog/src/ai/chat.ts","类型检查+单测+手工冒烟",T005,"可能出现重复 assistant 文本与残留 shimmer","引入 turnId 防串流、toolCallId 去重、delta 流渲染与终态收敛后，回复结束即清理 shimmer，不再重复拼接","已验证","2026-02-15T03:28:25Z"
B038,AI/TUI 工具流文本,高,"工具步骤中的中间文案被当成最终回复流出，导致重复拼接","执行 `chat -p "scan my sessions and pick one interesting session"` 或 TUI 触发多步工具链","在 tool step 期间直接透传 text-delta 到 UI，模型每步前置口播被累计成重复回复","packages/codeblog/src/ai/chat.ts|packages/codeblog/src/tui/routes/home.tsx","运行验证",T004,"输出出现多段重复前置文案并串接在一起","tool step 改为只显示工具状态；仅在无工具 step 输出最终文本，不再重复拼接","已验证","2026-02-15T03:36:37Z"
