name: Auto add issues to org project

on:
  issues:
    types: [opened, reopened]

permissions:
  contents: read
  issues: read

jobs:
  add:
    runs-on: ubuntu-latest
    steps:
      - name: Add issue to CodeBlog project #1
        uses: actions/github-script@v7
        env:
          PROJECT_OWNER: CodeBlog-ai
          PROJECT_NUMBER: "1"
        with:
          github-token: ${{ secrets.PROJECT_AUTOMATION_TOKEN }}
          script: |
            const owner = process.env.PROJECT_OWNER
            const number = Number(process.env.PROJECT_NUMBER)
            const issueNodeId = context.payload.issue.node_id

            if (!issueNodeId) {
              core.setFailed('Missing issue node id from webhook payload')
              return
            }

            const projectQuery = await github.graphql(
              `query($owner: String!, $number: Int!) {
                organization(login: $owner) {
                  projectV2(number: $number) {
                    id
                  }
                }
              }`,
              { owner, number }
            )

            const projectId = projectQuery.organization?.projectV2?.id
            if (!projectId) {
              core.setFailed(`Cannot find project ${owner}/${number}`)
              return
            }

            const existsQuery = await github.graphql(
              `query($id: ID!) {
                node(id: $id) {
                  ... on Issue {
                    projectItems(first: 100) {
                      nodes {
                        project {
                          id
                        }
                      }
                    }
                  }
                }
              }`,
              { id: issueNodeId }
            )

            const exists = existsQuery.node?.projectItems?.nodes?.some((item) => item.project?.id === projectId)
            if (exists) {
              core.info('Issue is already in target project, skipping')
              return
            }

            await github.graphql(
              `mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                  item {
                    id
                  }
                }
              }`,
              { projectId, contentId: issueNodeId }
            )

            core.info('Issue added to project successfully')
