#!/usr/bin/env node

import { spawnSync } from "child_process"
import fs from "fs"
import os from "os"
import path from "path"
import { fileURLToPath } from "url"

function run(target) {
  const result = spawnSync(target, process.argv.slice(2), {
    stdio: "inherit",
  })
  if (result.error) {
    console.error(result.error.message)
    process.exit(1)
  }
  process.exit(typeof result.status === "number" ? result.status : 0)
}

const self = fileURLToPath(import.meta.url)
const scriptDir = path.dirname(fs.realpathSync(self))

const platformMap = { darwin: "darwin", linux: "linux", win32: "windows" }
const archMap = { x64: "x64", arm64: "arm64" }
const platform = platformMap[os.platform()] || os.platform()
const arch = archMap[os.arch()] || os.arch()
const base = "codeblog-app-" + platform + "-" + arch
const binary = platform === "windows" ? "codeblog.exe" : "codeblog"
const pkgPath = path.join(scriptDir, "..", "package.json")
const srcEntry = path.join(scriptDir, "..", "src", "index.ts")

function packageVersion(filePath) {
  try {
    const text = fs.readFileSync(filePath, "utf-8")
    const data = JSON.parse(text)
    if (!data || typeof data !== "object") return undefined
    return typeof data.version === "string" ? data.version : undefined
  } catch {
    return undefined
  }
}

const expectedVersion = packageVersion(pkgPath)

function inGitCheckout(startDir) {
  let current = startDir
  for (;;) {
    if (fs.existsSync(path.join(current, ".git"))) return true
    const parent = path.dirname(current)
    if (parent === current) return false
    current = parent
  }
}

function bunPath() {
  if (process.env.BUN_INSTALL) {
    const candidate = path.join(process.env.BUN_INSTALL, "bin", "bun")
    if (fs.existsSync(candidate)) return candidate
  }
  const candidate = path.join(os.homedir(), ".bun", "bin", "bun")
  if (fs.existsSync(candidate)) return candidate
  return undefined
}

function runSource(bun) {
  const result = spawnSync(bun, ["run", srcEntry, ...process.argv.slice(2)], {
    stdio: "inherit",
    cwd: path.join(scriptDir, ".."),
  })
  if (result.error) {
    console.error(result.error.message)
    process.exit(1)
  }
  process.exit(typeof result.status === "number" ? result.status : 0)
}

function findBinary(startDir) {
  let current = startDir
  for (;;) {
    const modules = path.join(current, "node_modules")
    if (fs.existsSync(modules)) {
      const candidate = path.join(modules, base, "bin", binary)
      if (fs.existsSync(candidate)) {
        const candidateVersion = packageVersion(path.join(modules, base, "package.json"))
        if (!expectedVersion || !candidateVersion || candidateVersion === expectedVersion) return candidate
      }
    }
    const parent = path.dirname(current)
    if (parent === current) return undefined
    current = parent
  }
}

const bun = bunPath()
const devCheckout = inGitCheckout(scriptDir)
if (devCheckout && bun && fs.existsSync(srcEntry)) {
  runSource(bun)
}

const resolved = findBinary(scriptDir)
if (resolved) {
  run(resolved)
}

if (bun && fs.existsSync(srcEntry)) {
  runSource(bun)
}

console.error(
  "Could not find codeblog binary for your platform (" + base + ").\n" +
    "Try: npm install -g codeblog-app@latest\n" +
    "Or install bun: curl -fsSL https://bun.sh/install | bash",
)
process.exit(1)
